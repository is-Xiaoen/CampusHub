// Activity 服务 Proto 定义文件（外部服务）
//
// 文件说明：
//   定义活动模块的对外 gRPC 服务接口，供 Gateway API 调用。
//   包含活动 CRUD、状态操作、搜索、分类标签等功能。
//
// 字段编号规划：
//   - 1-50：基础字段
//   - 51-80：扩展字段
//   - 81-100：预留字段
//   ⚠️ 警告：字段编号一旦发布使用后不可更改或复用！
//
// 生成命令：
//   cd app/activity/rpc
//

syntax = "proto3";

package activity;//   goctl rpc protoc activity.proto --go_out=./pb --go-grpc_out=./pb --zrpc_out=.


option go_package = "./pb";


// ActivityService 活动服务（外部）

service ActivityService {
  // ==================== CRUD 接口 ====================

  // CreateActivity 创建活动
  // 支持保存为草稿或直接提交审核
  rpc CreateActivity(CreateActivityReq) returns (CreateActivityResp);

  // UpdateActivity 更新活动
  // 根据当前状态限制可编辑字段
  rpc UpdateActivity(UpdateActivityReq) returns (UpdateActivityResp);

  // DeleteActivity 删除活动
  // 软删除，有报名记录不可删除
  rpc DeleteActivity(DeleteActivityReq) returns (DeleteActivityResp);

  // GetActivity 获取活动详情
  rpc GetActivity(GetActivityReq) returns (GetActivityResp);

  // ListActivities 获取活动列表
  // 支持分页、筛选、排序
  rpc ListActivities(ListActivitiesReq) returns (ListActivitiesResp);

  // ==================== 状态操作接口 ====================

  // SubmitActivity 提交审核
  // 草稿(0)/已拒绝(5) → 待审核(1)
  rpc SubmitActivity(SubmitActivityReq) returns (SubmitActivityResp);

  // ApproveActivity 审核通过（仅管理员）
  // 待审核(1) → 已发布(2)
  rpc ApproveActivity(ApproveActivityReq) returns (ApproveActivityResp);

  // RejectActivity 审核拒绝（仅管理员）
  // 待审核(1) → 已拒绝(5)
  rpc RejectActivity(RejectActivityReq) returns (RejectActivityResp);

  // CancelActivity 取消活动
  // 组织者/管理员可操作
  rpc CancelActivity(CancelActivityReq) returns (CancelActivityResp);

  // ==================== 搜索接口 ====================

  // SearchActivities 搜索活动
  // 使用 ES/Meilisearch 实现全文搜索
  rpc SearchActivities(SearchActivitiesReq) returns (SearchActivitiesResp);

  // GetHotActivities 获取热门活动
  // 按报名人数排序，返回 Top N
  rpc GetHotActivities(GetHotActivitiesReq) returns (GetHotActivitiesResp);

  // ==================== 分类标签接口 ====================

  // ListCategories 获取分类列表
  rpc ListCategories(ListCategoriesReq) returns (ListCategoriesResp);

  // ListTags 获取标签列表
  rpc ListTags(ListTagsReq) returns (ListTagsResp);

  // ==================== 浏览量接口 ====================

  // IncrViewCount 增加浏览量
  // 带防刷策略：同一用户+活动 10分钟内只计1次
  rpc IncrViewCount(IncrViewCountReq) returns (IncrViewCountResp);
}

// 通用消息定义
// ============================================================================

// Tag 标签信息
message Tag {
  int64 id = 1;      // 标签ID
  string name = 2;   // 标签名称
  string color = 3;  // 标签颜色
  string icon = 4;   // 标签图标
  // 5-10 预留
}

// Category 分类信息
message Category {
  int64 id = 1;      // 分类ID
  string name = 2;   // 分类名称
  string icon = 3;   // 分类图标
  int32 sort = 4;    // 排序权重
  // 5-10 预留
}

// ActivityDetail 活动详情（完整信息）
message ActivityDetail {
  int64 id = 1;                          // 活动ID
  string title = 2;                      // 活动标题
  string cover_url = 3;                  // 封面URL
  int32 cover_type = 4;                  // 封面类型: 1=图片, 2=视频
  string content = 5;                    // 活动详情（富文本）
  int64 category_id = 6;                 // 分类ID
  string category_name = 7;              // 分类名称
  int64 organizer_id = 8;                // 组织者ID
  string organizer_name = 9;             // 组织者名称
  string organizer_avatar = 10;          // 组织者头像
  string contact_phone = 11;             // 联系电话（脱敏）
  int64 register_start_time = 12;        // 报名开始时间（时间戳秒）
  int64 register_end_time = 13;          // 报名截止时间（时间戳秒）
  int64 activity_start_time = 14;        // 活动开始时间（时间戳秒）
  int64 activity_end_time = 15;          // 活动结束时间（时间戳秒）
  string location = 16;                  // 活动地点
  string address_detail = 17;            // 详细地址
  double longitude = 18;                 // 经度
  double latitude = 19;                  // 纬度
  int32 max_participants = 20;           // 最大人数（0=不限）
  int32 current_participants = 21;       // 当前报名人数
  bool require_approval = 22;            // 是否需要审批
  bool require_student_verify = 23;      // 是否需要学生认证
  int32 min_credit_score = 24;           // 最低信用分要求
  int32 status = 25;                     // 活动状态(0-6)
  string status_text = 26;               // 状态文本
  string reject_reason = 27;             // 拒绝原因（状态=5时有值）
  int64 view_count = 28;                 // 浏览量
  int64 like_count = 29;                 // 点赞数
  repeated Tag tags = 30;                // 标签列表
  int64 created_at = 31;                 // 创建时间（时间戳秒）
  int64 updated_at = 32;                 // 更新时间（时间戳秒）
  int32 version = 33;                    // 乐观锁版本号
  // 34-50 预留基础字段
  // 51-80 扩展字段
}

// ActivityListItem 活动列表项（简化信息）
message ActivityListItem {
  int64 id = 1;                          // 活动ID
  string title = 2;                      // 活动标题
  string cover_url = 3;                  // 封面URL
  int32 cover_type = 4;                  // 封面类型
  string category_name = 5;              // 分类名称
  string organizer_name = 6;             // 组织者名称
  string organizer_avatar = 7;           // 组织者头像
  int64 activity_start_time = 8;         // 活动开始时间（时间戳秒）
  string location = 9;                   // 活动地点
  int32 max_participants = 10;           // 最大人数
  int32 current_participants = 11;       // 当前报名人数
  int32 status = 12;                     // 活动状态
  string status_text = 13;               // 状态文本
  repeated Tag tags = 14;                // 标签列表（简化版）
  int64 view_count = 15;                 // 浏览量
  int64 created_at = 16;                 // 创建时间
  // 17-25 预留
}

// Pagination 分页信息
message Pagination {
  int32 page = 1;        // 当前页码
  int32 page_size = 2;   // 每页数量
  int64 total = 3;       // 总记录数
  int32 total_pages = 4; // 总页数
}

// ============================================================================
// CRUD 接口消息定义
// ============================================================================

// ---------- CreateActivity 创建活动 ----------

message CreateActivityReq {
  string title = 1;                      // 活动标题，2-100字（必填）
  string cover_url = 2;                  // 封面URL（必填）
  int32 cover_type = 3;                  // 封面类型: 1=图片(默认), 2=视频
  string content = 4;                    // 活动详情（富文本）
  int64 category_id = 5;                 // 分类ID（必填）
  string contact_phone = 6;              // 联系电话
  int64 register_start_time = 7;         // 报名开始时间（时间戳秒，必填）
  int64 register_end_time = 8;           // 报名截止时间（时间戳秒，必填）
  int64 activity_start_time = 9;         // 活动开始时间（时间戳秒，必填）
  int64 activity_end_time = 10;          // 活动结束时间（时间戳秒，必填）
  string location = 11;                  // 活动地点（必填）
  string address_detail = 12;            // 详细地址
  double longitude = 13;                 // 经度
  double latitude = 14;                  // 纬度
  int32 max_participants = 15;           // 最大人数（0=不限，默认0）
  bool require_approval = 16;            // 是否需要审批（默认false）
  bool require_student_verify = 17;      // 是否需要学生认证（默认false）
  int32 min_credit_score = 18;           // 最低信用分要求（默认0）
  repeated int64 tag_ids = 19;           // 标签ID数组（最多5个）
  bool is_draft = 20;                    // true=保存草稿，false=直接提交审核

  // 以下由 Gateway 从 Token 解析后传入
  int64 organizer_id = 21;               // 组织者ID
  string organizer_name = 22;            // 组织者名称
  string organizer_avatar = 23;          // 组织者头像
  // 24-35 预留
}

message CreateActivityResp {
  int64 id = 1;      // 创建的活动ID
  int32 status = 2;  // 活动状态（0=草稿，1=待审核）
}

// ---------- UpdateActivity 更新活动 ----------

message UpdateActivityReq {
  int64 id = 1;                          // 活动ID（必填）
  int32 version = 2;                     // 乐观锁版本号（必填，用于并发控制）

  // 以下字段均为可选，只传需要更新的字段
  // 使用 optional 语义：字段存在则更新，不存在则不更新
  optional string title = 3;
  optional string cover_url = 4;
  optional int32 cover_type = 5;
  optional string content = 6;
  optional int64 category_id = 7;
  optional string contact_phone = 8;
  optional int64 register_start_time = 9;
  optional int64 register_end_time = 10;
  optional int64 activity_start_time = 11;
  optional int64 activity_end_time = 12;
  optional string location = 13;
  optional string address_detail = 14;
  optional double longitude = 15;
  optional double latitude = 16;
  optional int32 max_participants = 17;
  optional bool require_approval = 18;
  optional bool require_student_verify = 19;
  optional int32 min_credit_score = 20;

  // 标签更新：传入则全量替换
  repeated int64 tag_ids = 21;
  bool update_tags = 22;  // true 表示要更新标签（允许清空）

  // 操作人信息（Gateway 传入）
  int64 operator_id = 23;
  // 24-35 预留
}

message UpdateActivityResp {
  int32 status = 1;      // 更新后的状态
  int32 new_version = 2; // 新的版本号
}

// ---------- DeleteActivity 删除活动 ----------

message DeleteActivityReq {
  int64 id = 1;          // 活动ID（必填）
  int64 operator_id = 2; // 操作人ID（Gateway 传入）
  bool is_admin = 3;     // 是否管理员
}

message DeleteActivityResp {
  bool success = 1;  // 是否成功
}

// ---------- GetActivity 获取活动详情 ----------

message GetActivityReq {
  int64 id = 1;          // 活动ID（必填）
  int64 viewer_id = 2;   // 查看者ID（可选，用于权限判断）
}

message GetActivityResp {
  ActivityDetail activity = 1;  // 活动详情
}

// ---------- ListActivities 获取活动列表 ----------

message ListActivitiesReq {
  int32 page = 1;            // 页码，默认1
  int32 page_size = 2;       // 每页数量，默认10，最大50
  int64 category_id = 3;     // 分类ID筛选（0=全部）
  int32 status = 4;          // 状态筛选：-1=公开状态(2,3,4), -2=全部, 具体值=筛选该状态
  int64 organizer_id = 5;    // 组织者ID筛选
  string sort = 6;           // 排序方式: created_at(默认), hot, start_time

  // 操作人信息（用于权限判断）
  int64 viewer_id = 7;
  bool is_admin = 8;
  // 9-15 预留
}

message ListActivitiesResp {
  repeated ActivityListItem list = 1;  // 活动列表
  Pagination pagination = 2;           // 分页信息
}

// ============================================================================
// 状态操作接口消息定义
// ============================================================================

// ---------- SubmitActivity 提交审核 ----------

message SubmitActivityReq {
  int64 id = 1;          // 活动ID（必填）
  int64 operator_id = 2; // 操作人ID
}

message SubmitActivityResp {
  int32 status = 1;  // 新状态（1=待审核）
}

// ---------- ApproveActivity 审核通过 ----------

message ApproveActivityReq {
  int64 id = 1;          // 活动ID（必填）
  int64 operator_id = 2; // 操作人ID（管理员）
}

message ApproveActivityResp {
  int32 status = 1;  // 新状态（2=已发布）
}

// ---------- RejectActivity 审核拒绝 ----------

message RejectActivityReq {
  int64 id = 1;          // 活动ID（必填）
  string reason = 2;     // 拒绝原因，1-500字（必填）
  int64 operator_id = 3; // 操作人ID（管理员）
}

message RejectActivityResp {
  int32 status = 1;  // 新状态（5=已拒绝）
}

// ---------- CancelActivity 取消活动 ----------

message CancelActivityReq {
  int64 id = 1;          // 活动ID（必填）
  string reason = 2;     // 取消原因（可选）
  int64 operator_id = 3; // 操作人ID
  bool is_admin = 4;     // 是否管理员
}

message CancelActivityResp {
  int32 status = 1;  // 新状态（6=已取消）
}

// ============================================================================
// 搜索接口消息定义
// ============================================================================

// ---------- SearchActivities 搜索活动 ----------

message SearchActivitiesReq {
  string keyword = 1;        // 搜索关键词，2-50字（必填）
  int64 category_id = 2;     // 分类ID筛选（0=全部）
  int32 page = 3;            // 页码，默认1
  int32 page_size = 4;       // 每页数量，默认10，最大50
  string sort = 5;           // 排序: relevance(默认), time, hot
  // 6-10 预留
}

message SearchActivitiesResp {
  repeated ActivityListItem list = 1;  // 搜索结果列表（title 含高亮标签）
  int64 total = 2;                     // 总结果数
  int32 query_time_ms = 3;             // 搜索耗时（毫秒）
}

// ---------- GetHotActivities 获取热门活动 ----------

message GetHotActivitiesReq {
  int32 limit = 1;  // 返回数量，默认10，最大20
}

message GetHotActivitiesResp {
  repeated ActivityListItem list = 1;  // 热门活动列表
}

// ============================================================================
// 分类标签接口消息定义
// ============================================================================

// ---------- ListCategories 获取分类列表 ----------

message ListCategoriesReq {
  // 暂无参数，返回所有启用的分类
  // 1-5 预留
}

message ListCategoriesResp {
  repeated Category list = 1;  // 分类列表
}

// ---------- ListTags 获取标签列表 ----------

message ListTagsReq {
  int32 limit = 1;  // 返回数量：0=全部（默认），>0=热门N个
}

message ListTagsResp {
  repeated Tag list = 1;  // 标签列表
}

// ============================================================================
// 浏览量接口消息定义
// ============================================================================

// ---------- IncrViewCount 增加浏览量 ----------

message IncrViewCountReq {
  int64 id = 1;       // 活动ID（必填）
  int64 user_id = 2;  // 用户ID（用于防刷）
  string client_ip = 3; // 客户端IP（备用防刷）
}

message IncrViewCountResp {
  int64 view_count = 1;  // 当前浏览量
}
