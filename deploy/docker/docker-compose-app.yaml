# ============================================================================
# CampusHub 应用服务部署
# ============================================================================
#
# 架构说明：
#   客户端 → Nginx(:8888) → 各服务 API → 各服务 RPC → MySQL/Redis
#
# 端口规划：
#   - Nginx 网关: 8888（对外唯一入口）
#   - user-api: 8001, user-rpc: 9001
#   - activity-api: 8002, activity-rpc: 9002
#   - chat-api: 8003, chat-rpc: 9003
#
# 使用方法：
#   # 启动所有服务
#   docker-compose -f docker-compose-app.yaml up -d
#
#   # 查看日志
#   docker-compose -f docker-compose-app.yaml logs -f
#
#   # 停止服务
#   docker-compose -f docker-compose-app.yaml down
#
# ============================================================================

version: '3.8'

services:
  # ==================== Nginx 网关（统一入口） ====================
  nginx:
    image: nginx:alpine
    container_name: campushub-nginx
    restart: unless-stopped
    ports:
      - "8888:8888"
    volumes:
      - ../nginx/gateway.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8888/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - campushub-network
    depends_on:
      - user-api
      - activity-api
      - chat-api

  # ==================== User API 服务 ====================
  user-api:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        SERVICE: user
        TYPE: api
    image: campushub/user-api:latest
    container_name: campushub-user-api
    restart: unless-stopped
    ports:
      - "8001:8001"
    volumes:
      - ./config/user-api.yaml:/app/etc/config.yaml:ro
    environment:
      TZ: Asia/Shanghai
    networks:
      - campushub-network
    depends_on:
      - user-rpc

  # ==================== User RPC 服务 ====================
  user-rpc:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        SERVICE: user
        TYPE: rpc
    image: campushub/user-rpc:latest
    container_name: campushub-user-rpc
    restart: unless-stopped
    ports:
      - "9001:9001"
    volumes:
      - ./config/user-rpc.yaml:/app/etc/config.yaml:ro
    environment:
      TZ: Asia/Shanghai
    networks:
      - campushub-network

  # ==================== Activity API 服务 ====================
  activity-api:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        SERVICE: activity
        TYPE: api
    image: campushub/activity-api:latest
    container_name: campushub-activity-api
    restart: unless-stopped
    ports:
      - "8002:8002"
    volumes:
      - ./config/activity-api.yaml:/app/etc/config.yaml:ro
    environment:
      TZ: Asia/Shanghai
    networks:
      - campushub-network
    depends_on:
      - activity-rpc

  # ==================== Activity RPC 服务 ====================
  activity-rpc:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        SERVICE: activity
        TYPE: rpc
    image: campushub/activity-rpc:latest
    container_name: campushub-activity-rpc
    restart: unless-stopped
    ports:
      - "9002:9002"
    volumes:
      - ./config/activity-rpc.yaml:/app/etc/config.yaml:ro
    environment:
      TZ: Asia/Shanghai
    networks:
      - campushub-network

  # ==================== Chat API 服务 ====================
  chat-api:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        SERVICE: chat
        TYPE: api
    image: campushub/chat-api:latest
    container_name: campushub-chat-api
    restart: unless-stopped
    ports:
      - "8003:8003"
    volumes:
      - ./config/chat-api.yaml:/app/etc/config.yaml:ro
    environment:
      TZ: Asia/Shanghai
    networks:
      - campushub-network
    depends_on:
      - chat-rpc

  # ==================== Chat RPC 服务 ====================
  chat-rpc:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
      args:
        SERVICE: chat
        TYPE: rpc
    image: campushub/chat-rpc:latest
    container_name: campushub-chat-rpc
    restart: unless-stopped
    ports:
      - "9003:9003"
    volumes:
      - ./config/chat-rpc.yaml:/app/etc/config.yaml:ro
    environment:
      TZ: Asia/Shanghai
    networks:
      - campushub-network

networks:
  campushub-network:
    driver: bridge
