# ============================================================================
# CampusHub API Gateway - Production Ready
# ============================================================================
#
# 部署方式：
#   1. 复制到服务器: scp gateway.conf root@192.168.10.9:/etc/nginx/conf.d/campushub.conf
#   2. 测试配置: nginx -t
#   3. 重载: nginx -s reload
#
# 前端访问: http://192.168.10.9:8888/api/v1/...
#
# ============================================================================
#
# 服务端口映射：
#   user-api       → 8001  (prefix: /api/v1)
#   activity-api   → 8002  (prefix: /api/v1/activity, /api/v1/admin/activity)
#   chat-api       → 8003  (prefix: /api)
#   websocket      → 8889  (路径: /ws)
#
# 路由设计：
#   前端按后端实际路径直接请求，nginx 按路径前缀分发到对应服务
#   activity → /api/v1/activity/  和 /api/v1/admin/ （最长前缀优先匹配）
#   chat    → /api/groups/ 、/api/messages、/api/notifications、/api/users/
#   user    → /api/v1/ （兜底，匹配剩余所有 /api/v1/ 开头的请求）
#
# ============================================================================

# ==================== 限流配置（防刷） ====================
# 每个 IP 每秒 10 个请求，突发 20 个
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# 登录/注册接口单独限流：每个 IP 每秒 3 个请求（防暴力破解）
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=3r/s;

# 每个 IP 最多 100 个并发连接
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# ==================== 上游服务定义 ====================
upstream user_api {
    server 127.0.0.1:8001 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream activity_api {
    server 127.0.0.1:8002 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream chat_api {
    server 127.0.0.1:8003 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream websocket {
    server 127.0.0.1:8889 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# ==================== 主服务配置 ====================
server {
    listen 8888;
    server_name _;

    # 日志
    access_log /var/log/nginx/campushub_access.log;
    error_log /var/log/nginx/campushub_error.log;

    # 全局限流
    limit_req zone=api_limit burst=20 nodelay;
    limit_conn conn_limit 100;

    # 请求体大小限制（上传文件）
    client_max_body_size 10m;

    # 超时配置
    proxy_connect_timeout 10s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # ==================== 通用代理头 ====================
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";

    # ==================== CORS 跨域配置 ====================
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;
    add_header Access-Control-Max-Age 86400 always;

    # OPTIONS 预检请求快速返回
    if ($request_method = OPTIONS) {
        return 204;
    }

    # ==================== 健康检查 ====================
    location = /health {
        return 200 '{"status":"ok","service":"gateway","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }

    # ===========================================================================
    # 用户服务路由（user-api :8001）
    # ===========================================================================
    # user-api 后端 prefix: /api/v1，前端直接用原始路径请求，无需重写
    # nginx 用 /api/v1/ 作为兜底，activity 和 admin 的更长前缀会优先匹配
    #
    # 覆盖接口：
    #   [公开] POST /api/v1/login
    #   [公开] POST /api/v1/register
    #   [公开] POST /api/v1/refresh_token
    #   [公开] POST /api/v1/users/info/password/qq_email  忘记密码
    #   [公开] GET  /api/v1/captcha
    #   [公开] POST /api/v1/captcha
    #   [公开] GET  /api/v1/qq_code/register
    #   [公开] GET  /api/v1/qq_code/forgot_password
    #   [认证] GET  /api/v1/credit/logs
    #   [认证] GET  /api/v1/verify/student/current
    #   [认证] POST /api/v1/verify/student/apply
    #   [认证] POST /api/v1/verify/student/confirm
    #   [认证] POST /api/v1/verify/student/cancel
    #   [认证] POST /api/v1/logout
    #   [认证] POST /api/v1/users/info/password            修改密码
    #   [认证] POST /api/v1/interests
    #   [认证] GET  /api/v1/users/details
    #   [认证] POST /api/v1/users/details
    #   [认证] GET  /api/v1/qq_code/delete_user
    #   [认证] POST /api/v1/logoff

    # 登录/注册 单独限流（防暴力破解）
    location ~ ^/api/v1/(login|register)$ {
        limit_req zone=auth_limit burst=5 nodelay;
        proxy_pass http://user_api;
        proxy_set_header Authorization $http_authorization;
    }

    # 用户服务兜底路由（/api/v1/activity/ 和 /api/v1/admin/ 更长，会优先匹配走 activity）
    location /api/v1/ {
        proxy_pass http://user_api;
        proxy_set_header Authorization $http_authorization;
    }

    # ===========================================================================
    # 活动服务路由（activity-api :8002）
    # ===========================================================================
    # activity-api 后端 prefix 是 /api/v1/activity，路径完全匹配，直接转发
    #
    # 覆盖接口：
    #   [公开] GET  /api/v1/activity/lists            活动列表
    #   [公开] GET  /api/v1/activity/:id              活动详情
    #   [公开] GET  /api/v1/activity/search           搜索活动
    #   [公开] GET  /api/v1/activity/hot              热门活动
    #   [公开] GET  /api/v1/activity/categories       分类列表
    #   [公开] GET  /api/v1/activity/tags             标签列表
    #   [公开] POST /api/v1/activity/:id/view         增加浏览量
    #   [认证] POST /api/v1/activity/                 创建活动
    #   [认证] PUT  /api/v1/activity/:id              更新活动
    #   [认证] DEL  /api/v1/activity/:id              删除活动
    #   [认证] POST /api/v1/activity/:id/submit       提交审核
    #   [认证] POST /api/v1/activity/:id/cancel       取消活动
    #   [认证] GET  /api/v1/activity/my/created       我创建的活动
    #   [认证] POST /api/v1/activity/register         报名活动
    #   [认证] POST /api/v1/activity/cancel           取消报名
    #   [认证] GET  /api/v1/activity/list             待参加/已参加活动列表
    #   [认证] POST /api/v1/activity/verify           核销票券
    #   [认证] GET  /api/v1/activity/tickets          个人票券列表
    #   [认证] GET  /api/v1/activity/tickets/detail   票券详情

    location /api/v1/activity {
        proxy_pass http://activity_api;
        proxy_set_header Authorization $http_authorization;
    }

    # 管理员 - 活动审核接口（activity-api :8002）
    # 后端 prefix: /api/v1/admin/activity
    #
    # 覆盖接口：
    #   [管理员] POST /api/v1/admin/activity/:id/approve  审核通过
    #   [管理员] POST /api/v1/admin/activity/:id/reject   审核拒绝
    #   [管理员] GET  /api/v1/admin/activity/list         管理员活动列表

    location /api/v1/admin/ {
        proxy_pass http://activity_api;
        proxy_set_header Authorization $http_authorization;
    }

    # ===========================================================================
    # 聊天服务路由（chat-api :8003）
    # ===========================================================================
    # chat-api 后端 prefix: /api，前端直接用原始路径请求，无需重写
    # chat 的路径都在 /api/ 下（没有 v1），与 user 的 /api/v1/ 天然不冲突
    #
    # 覆盖接口：
    #   [认证] GET  /api/groups/:group_id           查询群信息
    #   [认证] GET  /api/groups/:group_id/members   群成员列表
    #   [认证] GET  /api/users/:user_id/groups      用户群列表
    #   [认证] GET  /api/messages                   消息历史
    #   [认证] GET  /api/messages/offline            离线消息
    #   [认证] GET  /api/notifications               通知列表
    #   [认证] GET  /api/notifications/unread-count  未读数量
    #   [认证] POST /api/notifications/read          标记已读
    #   [认证] POST /api/notifications/read-all      标记全部已读
    #   [认证] GET  /api/users/status                用户在线状态

    location /api/groups/ {
        proxy_pass http://chat_api;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/messages {
        proxy_pass http://chat_api;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/notifications {
        proxy_pass http://chat_api;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/users/ {
        proxy_pass http://chat_api;
        proxy_set_header Authorization $http_authorization;
    }

    # ===========================================================================
    # WebSocket 路由（websocket-service :8889）
    # ===========================================================================
    # WebSocket 是独立服务，端口 8889，不是 chat-api 的 8003
    # 前端连接: ws://192.168.10.9:8888/ws?token=xxx
    #
    # 覆盖端点：
    #   /ws                  WebSocket 连接（升级协议）
    #   /ws/health           WebSocket 服务健康检查
    #   /ws/stats            连接统计
    #   /ws/api/users/status 用户在线状态（HTTP）

    # WebSocket 连接（精确匹配，协议升级）
    location = /ws {
        proxy_pass http://websocket;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization $http_authorization;

        # WebSocket 长连接超时（1 小时）
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # WebSocket 服务的 HTTP 端点（健康检查、统计、用户状态）
    location /ws/ {
        # /ws/health → /health, /ws/stats → /stats, /ws/api/users/status → /api/users/status
        rewrite ^/ws/(.*)$ /$1 break;
        proxy_pass http://websocket;
        proxy_set_header Authorization $http_authorization;
    }

    # ==================== 404 处理 ====================
    location / {
        return 404 '{"code":404,"message":"API not found chunlu"}';
        add_header Content-Type application/json;
    }
}
