# ============================================================================
# Nginx 网关配置
# ============================================================================
#
# 说明：
#   Nginx 作为统一入口，只负责路由分发，不做业务逻辑。
#   JWT 鉴权由各 API 服务内部的 go-zero jwt:Auth 中间件处理。
#
# 架构：
#   客户端 → Nginx(:8888) → user-api(:8001)
#                         → activity-api(:8002)
#                         → chat-api(:8003)
#
# 部署方式：
#   1. 开发环境：docker-compose
#   2. 生产环境：K8s Ingress 或独立 Nginx
#
# ============================================================================

upstream user_api {
    server user-api:8001;
    # 如果本地开发，改为：
    # server 127.0.0.1:8001;
}

upstream activity_api {
    server activity-api:8002;
    # 如果本地开发，改为：
    # server 127.0.0.1:8002;
}

upstream chat_api {
    server chat-api:8003;
    # 如果本地开发，改为：
    # server 127.0.0.1:8003;
}

server {
    listen 8888;
    server_name localhost;

    # 日志
    access_log /var/log/nginx/gateway_access.log;
    error_log /var/log/nginx/gateway_error.log;

    # ==================== 通用配置 ====================

    # CORS 配置（可选，如果各 API 服务已配置则不需要）
    # add_header Access-Control-Allow-Origin *;
    # add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
    # add_header Access-Control-Allow-Headers "Authorization, Content-Type";

    # ==================== 健康检查 ====================

    location /health {
        default_type application/json;
        return 200 '{"status":"ok","service":"gateway"}';
    }

    # ==================== 用户服务路由 ====================

    location /api/v1/user/ {
        proxy_pass http://user_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 传递 Authorization 头（JWT Token）
        proxy_set_header Authorization $http_authorization;
    }

    # ==================== 活动服务路由 ====================

    location /api/v1/activity/ {
        proxy_pass http://activity_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
    }

    # ==================== 聊天服务路由 ====================

    location /api/v1/chat/ {
        proxy_pass http://chat_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $http_authorization;
    }

    # WebSocket 路由（如果 chat 服务支持）
    location /ws/ {
        proxy_pass http://chat_api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Authorization $http_authorization;

        # WebSocket 超时配置
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # ==================== 404 处理 ====================

    location / {
        default_type application/json;
        return 404 '{"code":404,"message":"接口不存在"}';
    }
}
