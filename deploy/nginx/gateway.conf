# ============================================================================
# CampusHub API Gateway - Production Ready
# ============================================================================
#
# 部署方式：
#   1. 复制到服务器: scp gateway.conf root@192.168.10.9:/etc/nginx/conf.d/campushub.conf
#   2. 测试配置: nginx -t
#   3. 重载: nginx -s reload
#
# 前端访问: http://192.168.10.9:8888/api/v1/...
#
# ============================================================================

# ==================== 限流配置（防刷） ====================
# 每个 IP 每秒 10 个请求，突发 20 个
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# 每个 IP 最多 100 个并发连接
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# ==================== 上游服务定义 ====================
upstream user_api {
    server 127.0.0.1:8001 max_fails=3 fail_timeout=30s;
    keepalive 32;  # 连接池
}

upstream activity_api {
    server 127.0.0.1:8002 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream chat_api {
    server 127.0.0.1:8003 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# ==================== 主服务配置 ====================
server {
    listen 8888;
    server_name _;

    # 日志（生产环境建议分离访问日志和错误日志）
    access_log /var/log/nginx/campushub_access.log;
    error_log /var/log/nginx/campushub_error.log;

    # 全局限流
    limit_req zone=api_limit burst=20 nodelay;
    limit_conn conn_limit 100;

    # 请求体大小限制（上传文件）
    client_max_body_size 10m;

    # 超时配置
    proxy_connect_timeout 10s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # ==================== 通用代理头 ====================
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";  # 启用 keepalive

    # ==================== CORS 跨域配置 ====================
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;
    add_header Access-Control-Max-Age 86400 always;

    # OPTIONS 预检请求快速返回
    if ($request_method = OPTIONS) {
        return 204;
    }

    # ==================== 健康检查 ====================
    location /health {
        return 200 '{"status":"ok","service":"gateway","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }

    # ==================== 用户服务路由 ====================
    # user-api 的 prefix 是 /api/v1（不含 /user）
    # 所以需要重写路径
    location /api/v1/user/ {
        # /api/v1/user/credit/logs -> /api/v1/credit/logs
        rewrite ^/api/v1/user/(.*)$ /api/v1/$1 break;
        proxy_pass http://user_api;
        proxy_set_header Authorization $http_authorization;
    }

    # ==================== 活动服务路由 ====================
    # activity-api 的 prefix 是 /api/v1/activity
    # 路径匹配，直接转发
    location /api/v1/activity/ {
        proxy_pass http://activity_api;
        proxy_set_header Authorization $http_authorization;
    }

    # 管理员接口
    location /api/v1/admin/ {
        proxy_pass http://activity_api;
        proxy_set_header Authorization $http_authorization;
    }

    # ==================== 聊天服务路由 ====================
    location /api/v1/chat/ {
        proxy_pass http://chat_api;
        proxy_set_header Authorization $http_authorization;
    }

    # ==================== WebSocket 路由 ====================
    location /ws/ {
        proxy_pass http://chat_api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Authorization $http_authorization;

        # WebSocket 长连接超时
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # ==================== 静态资源（可选） ====================
    # location /static/ {
    #     alias /opt/campushub/static/;
    #     expires 7d;
    # }

    # ==================== 404 处理 ====================
    location / {
        return 404 '{"code":404,"message":"API not found"}';
        add_header Content-Type application/json;
    }
}
