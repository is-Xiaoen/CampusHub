# ============================================================================
# Nginx 网关配置 - 本地开发环境
# ============================================================================
#
# 使用方法：
#   1. 安装 Nginx（Windows/Mac/Linux）
#   2. 将此文件复制到 Nginx 配置目录
#   3. 启动 Nginx
#
# 或者使用 Docker：
#   docker run -d -p 8888:8888 \
#     -v $(pwd)/gateway-local.conf:/etc/nginx/conf.d/default.conf:ro \
#     --name dev-nginx nginx:alpine
#
# ============================================================================

upstream user_api {
    server 127.0.0.1:8001;
}

upstream activity_api {
    server 127.0.0.1:8002;
}

upstream chat_api {
    server 127.0.0.1:8003;
}

server {
    listen 8888;
    server_name localhost;

    # ==================== 健康检查 ====================
    location /health {
        default_type application/json;
        return 200 '{"status":"ok","service":"gateway"}';
    }

    # ==================== 用户服务 ====================
    location /api/v1/user/ {
        proxy_pass http://user_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Authorization $http_authorization;
    }

    # ==================== 活动服务 ====================
    location /api/v1/activity/ {
        proxy_pass http://activity_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Authorization $http_authorization;
    }

    # ==================== 聊天服务 ====================
    location /api/v1/chat/ {
        proxy_pass http://chat_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Authorization $http_authorization;
    }

    # ==================== WebSocket ====================
    location /ws/ {
        proxy_pass http://chat_api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 3600s;
    }

    # ==================== 404 ====================
    location / {
        default_type application/json;
        return 404 '{"code":404,"message":"接口不存在"}';
    }
}
