# 活动模块 API 接口文档

> **版本**：v1.0
> **负责人**：马肖阳
> **更新日期**：2026-01-29
> **Base URL**：`/api/v1`

---

## 一、通用说明

### 1.1 请求头

| Header | 必填 | 说明 |
|--------|------|------|
| Authorization | 是 | Bearer Token（JWT） |
| Content-Type | 是 | application/json |
| X-Request-ID | 否 | 请求追踪ID |

### 1.2 响应格式

```json
{
  "code": 0,
  "message": "success",
  "data": { ... }
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| code | int | 状态码，0=成功，非0=失败 |
| message | string | 状态描述 |
| data | object | 业务数据 |

### 1.3 分页响应格式

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [...],
    "pagination": {
      "page": 1,
      "page_size": 10,
      "total": 100,
      "total_pages": 10
    }
  }
}
```

### 1.4 时间格式

统一使用 **ISO 8601** 格式：`2026-01-30T19:00:00+08:00`

### 1.5 错误码定义

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 10001 | 活动不存在 |
| 10002 | 状态不允许此操作 |
| 10003 | 无权限操作此活动 |
| 10004 | 时间设置无效 |
| 10005 | 标签数量超限（最多5个） |
| 10006 | 分类不存在或已禁用 |
| 10007 | 有报名记录不能删除 |
| 10008 | 有报名记录不能减少人数上限 |
| 10009 | 并发更新冲突，请重试 |
| 10301 | 搜索关键词不能为空 |
| 10302 | 搜索关键词过长（最多50字） |
| 10303 | 搜索服务暂不可用 |

### 1.6 活动状态定义

| 状态值 | 名称 | 说明 |
|--------|------|------|
| 0 | draft | 草稿 |
| 1 | pending | 待审核 |
| 2 | published | 已发布（报名中） |
| 3 | ongoing | 进行中 |
| 4 | finished | 已结束 |
| 5 | rejected | 已拒绝 |
| 6 | cancelled | 已取消 |

---

## 二、活动 CRUD 接口

### 2.1 创建活动

**POST** `/api/v1/activities`

#### 请求参数

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| title | string | 是 | 活动标题，2-100字 |
| cover_url | string | 是 | 封面URL |
| cover_type | int | 否 | 封面类型：1=图片（默认），2=视频 |
| content | string | 否 | 活动详情，富文本 |
| category_id | int | 是 | 分类ID |
| contact_phone | string | 否 | 联系电话 |
| register_start_time | string | 是 | 报名开始时间 |
| register_end_time | string | 是 | 报名截止时间 |
| activity_start_time | string | 是 | 活动开始时间 |
| activity_end_time | string | 是 | 活动结束时间 |
| location | string | 是 | 活动地点 |
| address_detail | string | 否 | 详细地址 |
| longitude | float | 否 | 经度 |
| latitude | float | 否 | 纬度 |
| max_participants | int | 否 | 最大人数，0=不限（默认0） |
| require_approval | bool | 否 | 是否需要审批（默认false） |
| require_student_verify | bool | 否 | 是否需要学生认证（默认false） |
| min_credit_score | int | 否 | 最低信用分要求（默认0） |
| tag_ids | int[] | 否 | 标签ID数组，最多5个 |
| is_draft | bool | 否 | true=保存草稿，false=直接提交审核（默认true） |

#### 请求示例

```json
{
  "title": "周五夜跑活动",
  "cover_url": "https://cdn.example.com/cover.jpg",
  "cover_type": 1,
  "content": "<p>一起来奥森公园跑步吧！</p>",
  "category_id": 1,
  "contact_phone": "13800138000",
  "register_start_time": "2026-01-30T08:00:00+08:00",
  "register_end_time": "2026-01-31T18:00:00+08:00",
  "activity_start_time": "2026-01-31T19:00:00+08:00",
  "activity_end_time": "2026-01-31T21:00:00+08:00",
  "location": "奥林匹克森林公园",
  "address_detail": "南门集合",
  "longitude": 116.407526,
  "latitude": 39.90403,
  "max_participants": 50,
  "require_approval": false,
  "require_student_verify": true,
  "min_credit_score": 60,
  "tag_ids": [1, 2, 3],
  "is_draft": false
}
```

#### 响应参数

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 活动ID |
| status | int | 活动状态（0=草稿，1=待审核） |

#### 响应示例

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 1001,
    "status": 1
  }
}
```

#### 业务规则

1. 时间顺序必须满足：报名开始 < 报名截止 ≤ 活动开始 < 活动结束
2. 非草稿模式下，报名开始时间不能早于当前时间
3. 标签最多选择5个
4. 分类必须存在且为启用状态
5. `is_draft=true` 创建为草稿状态(0)，`is_draft=false` 创建后直接提交审核变为待审核状态(1)

---

### 2.2 获取活动详情

**GET** `/api/v1/activities/{id}`

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | int | 活动ID |

#### 响应参数

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 活动ID |
| title | string | 活动标题 |
| cover_url | string | 封面URL |
| cover_type | int | 封面类型 |
| content | string | 活动详情 |
| category_id | int | 分类ID |
| category_name | string | 分类名称 |
| organizer_id | int | 组织者ID |
| organizer_name | string | 组织者名称 |
| organizer_avatar | string | 组织者头像 |
| contact_phone | string | 联系电话（脱敏：138****8000） |
| register_start_time | string | 报名开始时间 |
| register_end_time | string | 报名截止时间 |
| activity_start_time | string | 活动开始时间 |
| activity_end_time | string | 活动结束时间 |
| location | string | 活动地点 |
| address_detail | string | 详细地址 |
| longitude | float | 经度 |
| latitude | float | 纬度 |
| max_participants | int | 最大人数 |
| current_participants | int | 当前报名人数 |
| require_approval | bool | 是否需要审批 |
| require_student_verify | bool | 是否需要学生认证 |
| min_credit_score | int | 最低信用分 |
| status | int | 活动状态 |
| status_text | string | 状态文本 |
| reject_reason | string | 拒绝原因（状态=5时有值） |
| view_count | int | 浏览量 |
| tags | array | 标签列表 |
| tags[].id | int | 标签ID |
| tags[].name | string | 标签名称 |
| tags[].color | string | 标签颜色 |
| created_at | string | 创建时间 |
| updated_at | string | 更新时间 |

#### 响应示例

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": 1001,
    "title": "周五夜跑活动",
    "cover_url": "https://cdn.example.com/cover.jpg",
    "cover_type": 1,
    "content": "<p>一起来奥森公园跑步吧！</p>",
    "category_id": 1,
    "category_name": "运动健身",
    "organizer_id": 10001,
    "organizer_name": "张三",
    "organizer_avatar": "https://cdn.example.com/avatar.jpg",
    "contact_phone": "138****8000",
    "register_start_time": "2026-01-30T08:00:00+08:00",
    "register_end_time": "2026-01-31T18:00:00+08:00",
    "activity_start_time": "2026-01-31T19:00:00+08:00",
    "activity_end_time": "2026-01-31T21:00:00+08:00",
    "location": "奥林匹克森林公园",
    "address_detail": "南门集合",
    "longitude": 116.407526,
    "latitude": 39.90403,
    "max_participants": 50,
    "current_participants": 35,
    "require_approval": false,
    "require_student_verify": true,
    "min_credit_score": 60,
    "status": 2,
    "status_text": "报名中",
    "reject_reason": "",
    "view_count": 1234,
    "tags": [
      {"id": 1, "name": "跑步", "color": "orange"},
      {"id": 2, "name": "夜跑", "color": "purple"}
    ],
    "created_at": "2026-01-29T10:00:00+08:00",
    "updated_at": "2026-01-29T10:00:00+08:00"
  }
}
```

---

### 2.3 获取活动列表

**GET** `/api/v1/activities`

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | int | 否 | 页码，默认1 |
| page_size | int | 否 | 每页数量，默认10，最大50 |
| category_id | int | 否 | 分类ID筛选，0=全部 |
| status | int | 否 | 状态筛选，-1=公开状态(2,3,4)，-2=全部（需配合organizer_id），具体值=筛选该状态 |
| organizer_id | int | 否 | 组织者ID筛选（查询"我发布的"或"Ta发布的"） |
| sort | string | 否 | 排序方式：created_at(默认)、hot、start_time |

#### 请求示例

```
GET /api/v1/activities?page=1&page_size=10&category_id=1&status=-1&sort=hot
```

#### 响应参数

| 字段 | 类型 | 说明 |
|------|------|------|
| list | array | 活动列表 |
| list[].id | int | 活动ID |
| list[].title | string | 活动标题 |
| list[].cover_url | string | 封面URL |
| list[].cover_type | int | 封面类型 |
| list[].category_name | string | 分类名称 |
| list[].organizer_name | string | 组织者名称 |
| list[].organizer_avatar | string | 组织者头像 |
| list[].activity_start_time | string | 活动开始时间 |
| list[].location | string | 活动地点 |
| list[].max_participants | int | 最大人数 |
| list[].current_participants | int | 当前报名人数 |
| list[].status | int | 活动状态 |
| list[].status_text | string | 状态文本 |
| list[].tags | array | 标签列表（简化版） |
| pagination | object | 分页信息 |

#### 响应示例

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1001,
        "title": "周五夜跑活动",
        "cover_url": "https://cdn.example.com/cover.jpg",
        "cover_type": 1,
        "category_name": "运动健身",
        "organizer_name": "张三",
        "organizer_avatar": "https://cdn.example.com/avatar.jpg",
        "activity_start_time": "2026-01-31T19:00:00+08:00",
        "location": "奥林匹克森林公园",
        "max_participants": 50,
        "current_participants": 35,
        "status": 2,
        "status_text": "报名中",
        "tags": [
          {"id": 1, "name": "跑步", "color": "orange"}
        ]
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 10,
      "total": 100,
      "total_pages": 10
    }
  }
}
```

#### 使用场景

| 场景 | 参数 |
|------|------|
| 首页活动列表 | `status=-1` |
| 我发布的活动 | `organizer_id={我的ID}&status=-2` |
| Ta发布的活动 | `organizer_id={Ta的ID}&status=-1` |
| 某分类的活动 | `category_id={分类ID}&status=-1` |

---

### 2.4 更新活动

**PUT** `/api/v1/activities/{id}`

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | int | 活动ID |

#### 请求参数

> 所有字段均为可选，只传需要更新的字段

| 字段 | 类型 | 说明 |
|------|------|------|
| title | string | 活动标题 |
| cover_url | string | 封面URL |
| cover_type | int | 封面类型 |
| content | string | 活动详情 |
| category_id | int | 分类ID |
| contact_phone | string | 联系电话 |
| register_start_time | string | 报名开始时间 |
| register_end_time | string | 报名截止时间 |
| activity_start_time | string | 活动开始时间 |
| activity_end_time | string | 活动结束时间 |
| location | string | 活动地点 |
| address_detail | string | 详细地址 |
| longitude | float | 经度 |
| latitude | float | 纬度 |
| max_participants | int | 最大人数 |
| require_approval | bool | 是否需要审批 |
| require_student_verify | bool | 是否需要学生认证 |
| min_credit_score | int | 最低信用分 |
| tag_ids | int[] | 标签ID数组 |

#### 响应参数

| 字段 | 类型 | 说明 |
|------|------|------|
| status | int | 更新后的状态 |

#### 响应示例

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "status": 0
  }
}
```

#### 业务规则

| 当前状态 | 可编辑字段 | 更新后状态 |
|---------|-----------|-----------|
| 草稿(0) | 所有字段 | 不变 |
| 待审核(1) | 所有字段 | 变为草稿(0) |
| 已拒绝(5) | 所有字段 | 变为草稿(0) |
| 已发布(2) | content, cover_url, cover_type | 不变 |
| 进行中(3) | 不可编辑 | - |
| 已结束(4) | 不可编辑 | - |
| 已取消(6) | 不可编辑 | - |

**特殊限制**：已发布状态且有报名记录时，不能减少 `max_participants`

---

### 2.5 删除活动

**DELETE** `/api/v1/activities/{id}`

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | int | 活动ID |

#### 响应示例

```json
{
  "code": 0,
  "message": "success",
  "data": null
}
```

#### 业务规则

1. 只有活动组织者本人或管理员可以删除
2. 有报名记录的活动不能删除（返回错误码 10007）
3. 采用软删除，数据不会真正删除

---

## 三、状态操作接口

### 3.1 提交审核

**POST** `/api/v1/activities/{id}/submit`

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | int | 活动ID |

#### 响应参数

| 字段 | 类型 | 说明 |
|------|------|------|
| status | int | 新状态（1=待审核） |

#### 响应示例

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "status": 1
  }
}
```

#### 业务规则

- 仅组织者本人可操作
- 仅草稿(0)或已拒绝(5)状态可提交
- 提交前会进行完整性校验（必填字段、时间顺序等）

---

### 3.2 审核通过

**POST** `/api/v1/activities/{id}/approve`

> **权限**：仅管理员

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | int | 活动ID |

#### 响应参数

| 字段 | 类型 | 说明 |
|------|------|------|
| status | int | 新状态（2=已发布） |

#### 响应示例

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "status": 2
  }
}
```

#### 业务规则

- 仅待审核(1)状态可审核通过
- 通过后通知组织者（调用消息服务）

---

### 3.3 审核拒绝

**POST** `/api/v1/activities/{id}/reject`

> **权限**：仅管理员

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | int | 活动ID |

#### 请求参数

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| reason | string | 是 | 拒绝原因，1-500字 |

#### 请求示例

```json
{
  "reason": "活动描述不够详细，请补充具体的行程安排"
}
```

#### 响应参数

| 字段 | 类型 | 说明 |
|------|------|------|
| status | int | 新状态（5=已拒绝） |

#### 响应示例

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "status": 5
  }
}
```

---

### 3.4 取消活动

**POST** `/api/v1/activities/{id}/cancel`

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | int | 活动ID |

#### 请求参数

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| reason | string | 否 | 取消原因 |

#### 请求示例

```json
{
  "reason": "因天气原因取消"
}
```

#### 响应参数

| 字段 | 类型 | 说明 |
|------|------|------|
| status | int | 新状态（6=已取消） |

#### 业务规则

- 组织者可取消：草稿(0)、待审核(1)、已发布(2)状态
- 管理员可取消：任何非终态状态
- 已发布状态取消时，通知所有已报名用户（调用消息服务）

---

## 四、搜索接口

### 4.1 搜索活动

**GET** `/api/v1/activities/search`

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| q | string | 是 | 搜索关键词，2-50字 |
| category_id | int | 否 | 分类ID筛选，0=全部 |
| page | int | 否 | 页码，默认1 |
| page_size | int | 否 | 每页数量，默认10，最大50 |
| sort | string | 否 | 排序：relevance(默认)、time、hot |

#### 请求示例

```
GET /api/v1/activities/search?q=夜跑&category_id=1&page=1&page_size=10
```

#### 响应参数

| 字段 | 类型 | 说明 |
|------|------|------|
| list | array | 搜索结果列表（结构同活动列表） |
| total | int | 总结果数 |
| query_time_ms | int | 搜索耗时（毫秒） |

#### 响应示例

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1001,
        "title": "周五<em>夜跑</em>活动",
        "cover_url": "https://cdn.example.com/cover.jpg",
        "cover_type": 1,
        "category_name": "运动健身",
        "organizer_name": "张三",
        "organizer_avatar": "https://cdn.example.com/avatar.jpg",
        "activity_start_time": "2026-01-31T19:00:00+08:00",
        "location": "奥林匹克森林公园",
        "max_participants": 50,
        "current_participants": 35,
        "status": 2,
        "status_text": "报名中",
        "tags": []
      }
    ],
    "total": 15,
    "query_time_ms": 23
  }
}
```

#### 说明

- 搜索结果中 `title` 字段会包含高亮标签 `<em>关键词</em>`
- 只搜索已发布(2)和进行中(3)状态的活动
- 搜索服务不可用时返回错误码 10303

---

## 五、热门活动接口

### 5.1 获取热门活动

**GET** `/api/v1/activities/hot`

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| limit | int | 否 | 返回数量，默认10，最大20 |

#### 请求示例

```
GET /api/v1/activities/hot?limit=10
```

#### 响应参数

与活动列表接口的 `list` 结构相同，不含分页信息。

#### 响应示例

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1001,
        "title": "周五夜跑活动",
        "cover_url": "https://cdn.example.com/cover.jpg",
        "cover_type": 1,
        "category_name": "运动健身",
        "organizer_name": "张三",
        "organizer_avatar": "https://cdn.example.com/avatar.jpg",
        "activity_start_time": "2026-01-31T19:00:00+08:00",
        "location": "奥林匹克森林公园",
        "max_participants": 50,
        "current_participants": 35,
        "status": 2,
        "status_text": "报名中",
        "tags": []
      }
    ]
  }
}
```

#### 排序规则

按报名人数降序排列，只返回：
- 状态为已发布(2)或进行中(3)
- 活动结束时间 > 当前时间

---

## 六、浏览量接口

### 6.1 增加浏览量

**POST** `/api/v1/activities/{id}/view`

#### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | int | 活动ID |

#### 响应参数

| 字段 | 类型 | 说明 |
|------|------|------|
| view_count | int | 当前浏览量 |

#### 响应示例

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "view_count": 1235
  }
}
```

#### 防刷策略

- 同一用户 + 同一活动，10分钟内只计1次
- 浏览量先写入 Redis，定时批量同步到 MySQL

---

## 七、分类和标签接口

### 7.1 获取分类列表

**GET** `/api/v1/categories`

#### 响应参数

| 字段 | 类型 | 说明 |
|------|------|------|
| list | array | 分类列表 |
| list[].id | int | 分类ID |
| list[].name | string | 分类名称 |
| list[].icon | string | 分类图标 |

#### 响应示例

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {"id": 1, "name": "运动健身", "icon": "fa-running"},
      {"id": 2, "name": "户外探索", "icon": "fa-mountain"},
      {"id": 3, "name": "文化艺术", "icon": "fa-palette"},
      {"id": 4, "name": "学习成长", "icon": "fa-graduation-cap"},
      {"id": 5, "name": "社交聚会", "icon": "fa-users"},
      {"id": 6, "name": "志愿公益", "icon": "fa-hand-holding-heart"}
    ]
  }
}
```

---

### 7.2 获取标签列表

**GET** `/api/v1/tags`

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| limit | int | 否 | 返回数量，0=全部（默认），>0=热门N个 |

#### 请求示例

```
GET /api/v1/tags?limit=10
```

#### 响应参数

| 字段 | 类型 | 说明 |
|------|------|------|
| list | array | 标签列表 |
| list[].id | int | 标签ID |
| list[].name | string | 标签名称 |
| list[].color | string | 标签颜色 |
| list[].icon | string | 标签图标 |

#### 响应示例

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {"id": 1, "name": "跑步", "color": "orange", "icon": "fa-running"},
      {"id": 2, "name": "夜跑", "color": "purple", "icon": "fa-moon"},
      {"id": 3, "name": "徒步", "color": "green", "icon": "fa-hiking"}
    ]
  }
}
```

---

## 八、内部接口（gRPC）

> 供其他微服务调用，不对外暴露

### 8.1 获取活动基本信息

**Service**: `ActivityInternalService`
**Method**: `GetActivityBasic`

#### 请求参数

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int64 | 活动ID |

#### 响应参数

| 字段 | 类型 | 说明 |
|------|------|------|
| id | int64 | 活动ID |
| title | string | 活动标题 |
| status | int32 | 活动状态 |
| max_participants | int32 | 最大人数 |
| current_participants | int32 | 当前报名人数 |
| register_start_time | int64 | 报名开始时间（时间戳） |
| register_end_time | int64 | 报名截止时间（时间戳） |
| require_approval | bool | 是否需要审批 |
| require_student_verify | bool | 是否需要学生认证 |
| min_credit_score | int32 | 最低信用分 |
| organizer_id | int64 | 组织者ID |

#### Proto 定义

```protobuf
service ActivityInternalService {
  rpc GetActivityBasic(GetActivityBasicReq) returns (GetActivityBasicResp);
}

message GetActivityBasicReq {
  int64 id = 1;
}

message GetActivityBasicResp {
  int64 id = 1;
  string title = 2;
  int32 status = 3;
  int32 max_participants = 4;
  int32 current_participants = 5;
  int64 register_start_time = 6;
  int64 register_end_time = 7;
  bool require_approval = 8;
  bool require_student_verify = 9;
  int32 min_credit_score = 10;
  int64 organizer_id = 11;
}
```

---

## 九、接口汇总

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| POST | /api/v1/activities | 创建活动 | 登录用户 |
| GET | /api/v1/activities | 活动列表 | 公开 |
| GET | /api/v1/activities/{id} | 活动详情 | 公开 |
| PUT | /api/v1/activities/{id} | 更新活动 | 组织者 |
| DELETE | /api/v1/activities/{id} | 删除活动 | 组织者/管理员 |
| POST | /api/v1/activities/{id}/submit | 提交审核 | 组织者 |
| POST | /api/v1/activities/{id}/approve | 审核通过 | 管理员 |
| POST | /api/v1/activities/{id}/reject | 审核拒绝 | 管理员 |
| POST | /api/v1/activities/{id}/cancel | 取消活动 | 组织者/管理员 |
| GET | /api/v1/activities/search | 搜索活动 | 公开 |
| GET | /api/v1/activities/hot | 热门活动 | 公开 |
| POST | /api/v1/activities/{id}/view | 增加浏览量 | 登录用户 |
| GET | /api/v1/categories | 分类列表 | 公开 |
| GET | /api/v1/tags | 标签列表 | 公开 |

---

> 文档生成时间：2026-01-29
