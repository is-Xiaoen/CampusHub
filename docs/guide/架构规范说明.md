# æ¶æ„è§„èŒƒè¯´æ˜

æœ¬æ–‡æ¡£è¯´æ˜é¡¹ç›®éµå¾ªçš„æ¶æ„è§„èŒƒï¼Œä»¥åŠä¸ go-zero-looklook æœ€ä½³å®è·µçš„å¯¹é½æƒ…å†µã€‚

---

## ä¸€ã€ç›®å½•ç»“æ„è§„èŒƒ

### 1.1 æ­£ç¡®çš„æœåŠ¡ç›®å½•ç»“æ„

```
app/user/
â”œâ”€â”€ api/                    # HTTP æ¥å£å±‚
â”‚   â”œâ”€â”€ desc/
â”‚   â”‚   â””â”€â”€ user.api        # API å®šä¹‰æ–‡ä»¶
â”‚   â”œâ”€â”€ etc/
â”‚   â”‚   â””â”€â”€ user-api.yaml   # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ internal/
â”‚   â”‚   â”œâ”€â”€ config/         # é…ç½®ç»“æ„ä½“ï¼ˆgoctl ç”Ÿæˆï¼‰
â”‚   â”‚   â”œâ”€â”€ handler/        # HTTP å¤„ç†å™¨ï¼ˆgoctl ç”Ÿæˆï¼‰
â”‚   â”‚   â”œâ”€â”€ logic/          # ä¸šåŠ¡é€»è¾‘ï¼ˆä½ å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ svc/            # æœåŠ¡ä¸Šä¸‹æ–‡ï¼ˆä½ é…ç½®ï¼‰
â”‚   â”‚   â””â”€â”€ types/          # è¯·æ±‚å“åº”ç±»å‹ï¼ˆgoctl ç”Ÿæˆï¼‰
â”‚   â””â”€â”€ user.go             # å…¥å£æ–‡ä»¶
â”‚
â”œâ”€â”€ rpc/                    # gRPC æœåŠ¡å±‚
â”‚   â”œâ”€â”€ etc/
â”‚   â”‚   â””â”€â”€ user.yaml
â”‚   â”œâ”€â”€ internal/
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ logic/          # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆä½ å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ server/         # gRPC æœåŠ¡å®ç°ï¼ˆgoctl ç”Ÿæˆï¼‰
â”‚   â”‚   â””â”€â”€ svc/
â”‚   â”œâ”€â”€ pb/                 # protobuf ç”Ÿæˆçš„ä»£ç 
â”‚   â”œâ”€â”€ userclient/         # RPC å®¢æˆ·ç«¯ï¼ˆgoctl ç”Ÿæˆï¼‰
â”‚   â”œâ”€â”€ user.proto          # proto å®šä¹‰æ–‡ä»¶
â”‚   â””â”€â”€ user.go
â”‚
â””â”€â”€ model/                  # ğŸ‘ˆ æ•°æ®æ¨¡å‹å±‚ï¼ˆå’Œ api/rpc åŒçº§ï¼‰
    â”œâ”€â”€ user_model.go       # ç”¨æˆ·è¡¨æ¨¡å‹
    â”œâ”€â”€ user_model_gen.go   # goctl model ç”Ÿæˆçš„ä»£ç 
    â””â”€â”€ vars.go             # å˜é‡å®šä¹‰
```

### 1.2 ä¸ºä»€ä¹ˆ model è¦å’Œ api/rpc åŒçº§ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Model ç›®å½•ä½ç½®è¯´æ˜                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   âŒ é”™è¯¯åšæ³•ï¼šæ”¾åœ¨ rpc/internal/model                                   â”‚
â”‚   â”œâ”€â”€ model è¢« internal ç›®å½•ä¿æŠ¤ï¼Œå…¶ä»–åŒ…æ— æ³•è®¿é—®                          â”‚
â”‚   â””â”€â”€ å¦‚æœ API éœ€è¦ç›´æ¥è®¿é—®æ•°æ®åº“ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰ï¼Œæ— æ³•å¤ç”¨                     â”‚
â”‚                                                                         â”‚
â”‚   âœ… æ­£ç¡®åšæ³•ï¼šæ”¾åœ¨ app/xxx/model                                        â”‚
â”‚   â”œâ”€â”€ model ä½œä¸ºç‹¬ç«‹å±‚ï¼Œå¯è¢« rpc å¼•ç”¨                                    â”‚
â”‚   â”œâ”€â”€ ç»“æ„æ¸…æ™°ï¼šapi â†’ rpc â†’ model                                       â”‚
â”‚   â””â”€â”€ ç¬¦åˆ go-zero-looklook æœ€ä½³å®è·µ                                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å±‚çº§è°ƒç”¨è§„åˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è°ƒç”¨è§„åˆ™                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   âœ… å…è®¸çš„è°ƒç”¨ï¼š                                                        â”‚
â”‚   â”œâ”€â”€ api/logic  â†’  rpcï¼ˆé€šè¿‡ RPC è°ƒç”¨ï¼‰                                â”‚
â”‚   â”œâ”€â”€ rpc/logic  â†’  modelï¼ˆç›´æ¥å¯¼å…¥ï¼‰                                   â”‚
â”‚   â””â”€â”€ api/logic  â†’  å…¶ä»–æœåŠ¡çš„ rpc                                      â”‚
â”‚                                                                         â”‚
â”‚   âŒ ç¦æ­¢çš„è°ƒç”¨ï¼š                                                        â”‚
â”‚   â”œâ”€â”€ api/logic  â†’  modelï¼ˆAPI ä¸èƒ½ç›´æ¥è®¿é—®æ•°æ®åº“ï¼‰                      â”‚
â”‚   â”œâ”€â”€ api/logic  â†’  rpc/internalï¼ˆinternal åŒ…å—ä¿æŠ¤ï¼‰                   â”‚
â”‚   â””â”€â”€ rpc/logic  â†’  å…¶ä»–æœåŠ¡çš„ modelï¼ˆè·¨æœåŠ¡å¿…é¡»èµ° RPCï¼‰                 â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€é”™è¯¯å¤„ç†è§„èŒƒ

### 2.1 ç»Ÿä¸€å“åº”æ ¼å¼

æ‰€æœ‰ API å“åº”å¿…é¡»ä½¿ç”¨ç»Ÿä¸€æ ¼å¼ï¼š

```json
// æˆåŠŸ
{
    "code": 0,
    "message": "success",
    "data": { ... }
}

// å¤±è´¥
{
    "code": 2001,
    "message": "ç”¨æˆ·ä¸å­˜åœ¨"
}
```

### 2.2 é”™è¯¯ç è§„èŒƒ

```go
// common/errorx/codes.go

// é”™è¯¯ç è§„èŒƒï¼š
// 0       - æˆåŠŸ
// 1xxx    - é€šç”¨é”™è¯¯
// 2xxx    - ç”¨æˆ·æœåŠ¡é”™è¯¯
// 3xxx    - æ´»åŠ¨æœåŠ¡é”™è¯¯
// 4xxx    - èŠå¤©æœåŠ¡é”™è¯¯

const (
    CodeSuccess       = 0     // æˆåŠŸ
    CodeInternalError = 1000  // å†…éƒ¨é”™è¯¯
    CodeInvalidParams = 1001  // å‚æ•°é”™è¯¯
    CodeUnauthorized  = 1002  // æœªæˆæƒ
    // ...
)
```

### 2.3 å…¨å±€é”™è¯¯å¤„ç†å™¨ï¼ˆå…³é”®ï¼‰

**é—®é¢˜ï¼š** goctl ç”Ÿæˆçš„ handler é»˜è®¤ä½¿ç”¨ `httpx.ErrorCtx`ï¼Œå“åº”æ ¼å¼æ˜¯ `{"error": "xxx"}`

**è§£å†³æ–¹æ¡ˆï¼š** åœ¨ main.go ä¸­è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†å™¨

```go
// main.go
package main

import (
    "activity-platform/common/response"
    // ...
)

func main() {
    flag.Parse()

    // ========================================
    // é‡è¦ï¼šå¿…é¡»åœ¨ server.Start() ä¹‹å‰è°ƒç”¨
    // ========================================
    response.SetupGlobalErrorHandler()
    // ========================================

    var c config.Config
    conf.MustLoad(*configFile, &c)

    server := rest.MustNewServer(c.RestConf)
    defer server.Stop()

    // ...
    server.Start()
}
```

### 2.4 Logic å±‚è¿”å›é”™è¯¯

```go
// internal/logic/xxx_logic.go

func (l *GetUserLogic) GetUser(req *types.GetUserReq) (*types.GetUserResp, error) {
    user, err := l.svcCtx.UserRpc.GetUserInfo(l.ctx, &userpb.GetUserInfoReq{
        UserId: req.UserId,
    })
    if err != nil {
        // ä½¿ç”¨ä¸šåŠ¡é”™è¯¯ç 
        return nil, errorx.NewWithMessage(errorx.CodeNotFound, "ç”¨æˆ·ä¸å­˜åœ¨")
    }

    return &types.GetUserResp{
        UserId:   user.UserId,
        Nickname: user.Nickname,
    }, nil
}
```

---

## ä¸‰ã€é…ç½®è§„èŒƒ

### 3.1 JWT é…ç½®ï¼ˆæ‰€æœ‰ API æœåŠ¡å¿…é¡»ä¸€è‡´ï¼‰

```yaml
# æ‰€æœ‰ xxx-api.yaml å¿…é¡»ä½¿ç”¨ç›¸åŒçš„ AccessSecret

Auth:
  AccessSecret: "your-secret-key-32-chars-long-xxx"  # å¿…é¡»ä¸€è‡´
  AccessExpire: 7200                                  # å¯ä»¥ä¸åŒ
```

### 3.2 RPC å®¢æˆ·ç«¯é…ç½®

```yaml
# activity-api.yaml

UserRpc:
  Etcd:
    Hosts:
      - 127.0.0.1:2379
    Key: user.rpc

ActivityRpc:
  Etcd:
    Hosts:
      - 127.0.0.1:2379
    Key: activity.rpc
```

### 3.3 æ•°æ®åº“é…ç½®ï¼ˆä»… RPC æœåŠ¡ï¼‰

```yaml
# user-rpc.yaml (user.yaml)

MySQL:
  DataSource: "root:password@tcp(127.0.0.1:3306)/campus_activity?charset=utf8mb4&parseTime=True&loc=Local"

Redis:
  Host: 127.0.0.1:6379
  Type: node
```

---

## å››ã€ä»£ç ç”Ÿæˆè§„èŒƒ

### 4.1 API ä»£ç ç”Ÿæˆ

```bash
cd app/user/api
goctl api go -api desc/user.api -dir . -style go_zero
```

ç”Ÿæˆåéœ€è¦ï¼š
1. å®ç° `internal/logic/*.go` ä¸­çš„ä¸šåŠ¡é€»è¾‘
2. é…ç½® `internal/svc/service_context.go` ä¸­çš„ä¾èµ–

### 4.2 RPC ä»£ç ç”Ÿæˆ

```bash
cd app/user/rpc
goctl rpc protoc user.proto --go_out=. --go-grpc_out=. --zrpc_out=. -style go_zero
```

### 4.3 Model ä»£ç ç”Ÿæˆ

```bash
cd app/user/model

# ä»æ•°æ®åº“ç”Ÿæˆ
goctl model mysql datasource \
  -url "root:password@tcp(127.0.0.1:3306)/campus_activity" \
  -table "user" \
  -dir . \
  -style go_zero

# æˆ–ä» SQL æ–‡ä»¶ç”Ÿæˆ
goctl model mysql ddl -src user.sql -dir . -style go_zero
```

---

## äº”ã€å…¬å…±ç»„ä»¶ä½¿ç”¨è§„èŒƒ

### 5.1 ç›®å½•ç»“æ„

```
common/
â”œâ”€â”€ errorx/           # é”™è¯¯å®šä¹‰
â”‚   â”œâ”€â”€ codes.go      # é”™è¯¯ç å¸¸é‡
â”‚   â””â”€â”€ error.go      # BizError ç±»å‹
â”œâ”€â”€ response/         # å“åº”å°è£…
â”‚   â””â”€â”€ response.go   # ç»Ÿä¸€å“åº”æ ¼å¼
â”œâ”€â”€ ctxdata/          # Context å·¥å…·
â”‚   â””â”€â”€ ctxdata.go    # è·å– userId ç­‰
â”œâ”€â”€ constants/        # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ status.go     # çŠ¶æ€å¸¸é‡
â”‚   â””â”€â”€ redis_key.go  # Redis Key å‰ç¼€
â””â”€â”€ utils/            # å·¥å…·å‡½æ•°
    â”œâ”€â”€ jwt/          # JWT å·¥å…·ï¼ˆæ¨æ˜¥è·¯å®ç°ï¼‰
    â”œâ”€â”€ encrypt/      # åŠ å¯†å·¥å…·
    â””â”€â”€ validate/     # éªŒè¯å·¥å…·
```

### 5.2 ä½¿ç”¨ç¤ºä¾‹

```go
import (
    "activity-platform/common/errorx"
    "activity-platform/common/ctxdata"
)

func (l *CreateActivityLogic) CreateActivity(req *types.CreateActivityReq) (*types.CreateActivityResp, error) {
    // è·å–å½“å‰ç”¨æˆ· ID
    userId, err := ctxdata.GetUserIdFromCtx(l.ctx)
    if err != nil {
        return nil, errorx.ErrUnauthorized()
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
    if err := ctxdata.RequireAdmin(l.ctx); err != nil {
        return nil, err
    }

    // ä¸šåŠ¡é€»è¾‘...
}
```

---

## å…­ã€ä¸ go-zero-looklook å¯¹æ¯”

| é¡¹ç›® | go-zero-looklook | æœ¬é¡¹ç›® | è¯´æ˜ |
|------|------------------|--------|------|
| Model ä½ç½® | `app/xxx/model/` | âœ… `app/xxx/model/` | å·²å¯¹é½ |
| é”™è¯¯å¤„ç† | è‡ªå®šä¹‰ `pkg/xerr` | âœ… `common/errorx` | å·²å¯¹é½ |
| å“åº”å°è£… | è‡ªå®šä¹‰ | âœ… `common/response` | å·²å¯¹é½ |
| å…¨å±€é”™è¯¯å¤„ç†å™¨ | `httpx.SetErrorHandler` | âœ… å·²è®¾ç½® | å·²å¯¹é½ |
| JWT éªŒè¯ | go-zero å†…ç½® | âœ… go-zero å†…ç½® | å·²å¯¹é½ |

---

## ä¸ƒã€æ£€æŸ¥æ¸…å•

å¼€å‘å‰è¯·ç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š

- [ ] Model ç›®å½•åœ¨ `app/xxx/model/` è€Œé `rpc/internal/model/`
- [ ] main.go ä¸­è°ƒç”¨äº† `response.SetupGlobalErrorHandler()`
- [ ] æ‰€æœ‰ API æœåŠ¡çš„ `AccessSecret` é…ç½®ä¸€è‡´
- [ ] Logic å±‚è¿”å›é”™è¯¯æ—¶ä½¿ç”¨ `errorx.NewWithMessage()` æˆ– `errorx.New()`
- [ ] API å±‚ä¸ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œå¿…é¡»é€šè¿‡ RPC
- [ ] è·¨æœåŠ¡è°ƒç”¨å¿…é¡»é€šè¿‡ RPCï¼Œä¸èƒ½ç›´æ¥å¯¼å…¥å…¶ä»–æœåŠ¡çš„ model
