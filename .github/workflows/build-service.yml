# ============================================================================
# CampusHub 服务构建（可复用工作流）
# ============================================================================
#
# 被 ci-cd.yml 通过 workflow_call 调用，不能单独触发
#
# 功能：
#   1. 登录 GHCR
#   2. Docker 多阶段构建
#   3. 推送镜像（短 SHA tag + latest）
#
# ============================================================================
name: Build Service

on:
  workflow_call:
    inputs:
      service:
        required: true
        type: string
        description: '服务名：user / activity / chat'
      type:
        required: true
        type: string
        description: '服务类型：api / rpc'

env:
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/campushub

jobs:
  build:
    runs-on: [self-hosted, linux, x64]
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push
        run: |
          # GHCR 要求镜像名全小写
          IMAGE=$(echo "${{ env.IMAGE_PREFIX }}/${{ inputs.service }}-${{ inputs.type }}" | tr '[:upper:]' '[:lower:]')
          SHORT_TAG=$(echo "${{ github.sha }}" | cut -c1-7)
          
          echo "Building ${IMAGE}:${SHORT_TAG} ..."
          
          DOCKER_BUILDKIT=1 docker build \
            --network=host \
            --build-arg SERVICE=${{ inputs.service }} \
            --build-arg TYPE=${{ inputs.type }} \
            -t ${IMAGE}:${SHORT_TAG} \
            -t ${IMAGE}:latest \
            -f deploy/docker/Dockerfile .
          
          docker push ${IMAGE}:${SHORT_TAG}
          docker push ${IMAGE}:latest
          
          echo "✅ Pushed ${IMAGE}:${SHORT_TAG}"